<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Guide - Navegue pelo Campus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            background: #f0f2f5;
        }

        /* Mapa Interativo */
        #map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Painel do Chat */
        #chat-panel {
            width: 400px;
            background: white;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #ddd;
        }

        #chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        #chat-header h2 {
            margin-bottom: 5px;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.bot {
            background: #f0f2f5;
            color: #333;
            align-self: flex-start;
        }

        #chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
        }

        #chat-input-form {
            display: flex;
            gap: 10px;
        }

        #chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #chat-input:focus {
            border-color: #667eea;
        }

        #send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        #send-button:hover {
            transform: scale(1.05);
        }

        #send-button:active {
            transform: scale(0.95);
        }

        /* Controles do Mapa */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 320px;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .map-controls select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .map-controls select:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn-tracar-rota {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn-tracar-rota:hover {
            transform: translateY(-2px);
        }

        .btn-tracar-rota:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-limpar-rota {
            width: 100%;
            padding: 8px;
            background: #f0f2f5;
            color: #666;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .btn-limpar-rota:hover {
            background: #e4e6eb;
        }

        /* Marcador de Local */
        .location-marker {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        .location-marker.origin {
            background: #28a745;
        }

        .location-marker.destination {
            background: #dc3545;
        }

        /* Responsivo Mobile */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #map-container {
                height: 50%;
            }

            #chat-panel {
                width: 100%;
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa Interativo -->
    <div id="map-container">
        <div class="map-controls">
            <div class="control-group">
                <label for="predio-select">Selecione o pr√©dio:</label>
                <select id="predio-select">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <div class="control-group">
                <label for="origem-select">Origem:</label>
                <select id="origem-select">
                    <option value="">Selecione um local</option>
                </select>
            </div>

            <div class="control-group">
                <label for="destino-select">Destino:</label>
                <select id="destino-select">
                    <option value="">Selecione um local</option>
                </select>
            </div>

            <button id="tracar-rota-btn" class="btn-tracar-rota" disabled>Tra√ßar Rota</button>
            <button id="limpar-rota-btn" class="btn-limpar-rota">Limpar Rota</button>
        </div>
        <div id="map"></div>
    </div>

    <!-- Painel do Chat -->
    <div id="chat-panel">
        <div id="chat-header">
            <h2>Campus Guide</h2>
            <p>Seu assistente de navega√ß√£o</p>
        </div>
        <div id="chat-messages">
            <div class="message bot">
                Ol√°! Sou o assistente do Campus Guide. Como posso te ajudar a encontrar um local no campus?
            </div>
        </div>
        <div id="chat-input-container">
            <form id="chat-input-form">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Pergunte algo... Ex: Onde fica a sala 101?"
                    autocomplete="off"
                >
                <button type="submit" id="send-button">Enviar</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configura√ß√£o da API
        const API_URL = 'http://localhost:8000';

        // Estado da aplica√ß√£o
        let mapaAtual = null;
        let marcadores = [];
        let prediosData = [];
        let linhaRota = null;
        let marcadoresRota = [];
        let geojsonLayer = null;
        let svgOverlay = null;

        // Inicializar mapa Leaflet
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 2
        });

        // Carregar GeoJSON dos pr√©dios
        async function carregarGeoJSON() {
            try {
                const response = await fetch(`${API_URL}/api/geojson`);
                const geojson = await response.json();
                
                // Renderizar GeoJSON no mapa
                geojsonLayer = L.geoJSON(geojson, {
                    style: {
                        color: '#667eea',
                        weight: 3,
                        fillOpacity: 0.1,
                        fillColor: '#764ba2'
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        layer.bindPopup(`
                            <strong>${props.nome}</strong><br>
                            ${props.descricao || ''}<br>
                            <small>Clique para ver detalhes</small>
                        `);
                        
                        layer.on('click', () => {
                            // Zoom no pr√©dio
                            map.fitBounds(layer.getBounds());
                            
                            // Carregar detalhes do pr√©dio
                            carregarMapaPredio(props.predio_id);
                        });
                    }
                }).addTo(map);
                
                // Ajusta a visualiza√ß√£o para mostrar todos os pr√©dios
                if (geojson.features.length > 0) {
                    map.fitBounds(geojsonLayer.getBounds());
                }
                
            } catch (error) {
                console.error('Erro ao carregar GeoJSON:', error);
            }
        }

        // Carregar dados dos pr√©dios
        async function carregarPredios() {
            try {
                const response = await fetch(`${API_URL}/api/predios`);
                const data = await response.json();
                prediosData = data.predios;
                
                const select = document.getElementById('predio-select');
                select.innerHTML = '<option value="">Selecione um pr√©dio</option>';
                
                prediosData.forEach(predio => {
                    const option = document.createElement('option');
                    option.value = predio.id;
                    option.textContent = predio.nome;
                    select.appendChild(option);
                });

                // Carregar primeiro pr√©dio automaticamente
                if (prediosData.length > 0) {
                    select.value = prediosData[0].id;
                    carregarMapaPredio(prediosData[0].id);
                }
            } catch (error) {
                console.error('Erro ao carregar pr√©dios:', error);
                adicionarMensagemBot('‚ö†Ô∏è Erro ao conectar com o servidor. Verifique se o backend est√° rodando.');
            }
        }

        // Carregar mapa de um pr√©dio espec√≠fico
        async function carregarMapaPredio(predioId) {
            try {
                const response = await fetch(`${API_URL}/api/predios/${predioId}`);
                const predio = await response.json();
                
                // Limpar marcadores antigos
                marcadores.forEach(m => map.removeLayer(m));
                marcadores = [];

                // Remover camada de imagem antiga
                if (mapaAtual) {
                    map.removeLayer(mapaAtual);
                }
                
                // Remover SVG overlay antigo
                if (svgOverlay) {
                    map.removeLayer(svgOverlay);
                    svgOverlay = null;
                }

                // Adicionar imagem do mapa
                const bounds = [[0, 0], [predio.dimensoes.altura, predio.dimensoes.largura]];
                mapaAtual = L.imageOverlay(
                    `${API_URL}${predio.imagem_url}`,
                    bounds
                ).addTo(map);

                map.fitBounds(bounds);
                
                // Carregar SVG overlay se dispon√≠vel
                if (predio.svg_url) {
                    carregarSVGOverlay(predio.svg_url, bounds);
                }

                // Adicionar marcadores dos locais
                predio.locais.forEach(local => {
                    const marker = L.marker(
                        [local.coordenadas.y, local.coordenadas.x],
                        {
                            icon: L.divIcon({
                                className: 'location-marker',
                                html: local.nome
                            })
                        }
                    ).addTo(map);

                    marker.bindPopup(`
                        <strong>${local.nome}</strong><br>
                        ${local.descricao || ''}
                    `);

                    marcadores.push(marker);
                });

                // Atualizar seletores de origem e destino
                atualizarSeletoresLocais(predioId, predio.locais);

            } catch (error) {
                console.error('Erro ao carregar mapa:', error);
            }
        }
        
        // Carregar SVG overlay sobre a imagem
        async function carregarSVGOverlay(svgUrl, bounds) {
            try {
                const response = await fetch(`${API_URL}${svgUrl}`);
                const svgText = await response.text();
                
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;
                
                // Criar overlay SVG
                svgOverlay = L.svgOverlay(svgElement, bounds, {
                    interactive: true,
                    opacity: 0.7
                }).addTo(map);
                
                // Adicionar interatividade aos elementos do SVG
                adicionarInteratividadeSVG(svgElement);
                
            } catch (error) {
                console.error('Erro ao carregar SVG overlay:', error);
            }
        }
        
        // Adicionar eventos de clique aos elementos do SVG
        function adicionarInteratividadeSVG(svgElement) {
            // Tornar salas clic√°veis
            const salas = svgElement.querySelectorAll('[id^="sala_"], [class*="room"]');
            salas.forEach(sala => {
                sala.style.cursor = 'pointer';
                sala.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const salaId = sala.id || sala.getAttribute('class');
                    adicionarMensagemBot(`Voc√™ clicou em: ${salaId}`);
                    
                    // Destacar a sala
                    sala.style.fill = '#667eea';
                    sala.style.fillOpacity = '0.3';
                    
                    setTimeout(() => {
                        sala.style.fill = '';
                        sala.style.fillOpacity = '';
                    }, 2000);
                });
                
                sala.addEventListener('mouseenter', () => {
                    sala.style.strokeWidth = '4';
                    sala.style.stroke = '#667eea';
                });
                
                sala.addEventListener('mouseleave', () => {
                    sala.style.strokeWidth = '';
                    sala.style.stroke = '';
                });
            });
        }

        // Atualizar seletores de origem e destino
        function atualizarSeletoresLocais(predioId, locais) {
            const selectOrigem = document.getElementById('origem-select');
            const selectDestino = document.getElementById('destino-select');
            
            selectOrigem.innerHTML = '<option value="">Selecione um local</option>';
            selectDestino.innerHTML = '<option value="">Selecione um local</option>';
            
            locais.forEach(local => {
                const option1 = document.createElement('option');
                option1.value = JSON.stringify({
                    predio_id: predioId,
                    local_id: local.id,
                    coordenadas: local.coordenadas
                });
                option1.textContent = local.nome;
                selectOrigem.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = JSON.stringify({
                    predio_id: predioId,
                    local_id: local.id,
                    coordenadas: local.coordenadas
                });
                option2.textContent = local.nome;
                selectDestino.appendChild(option2);
            });
        }

        // Verificar se pode tra√ßar rota
        function verificarRotaCompleta() {
            const origem = document.getElementById('origem-select').value;
            const destino = document.getElementById('destino-select').value;
            document.getElementById('tracar-rota-btn').disabled = !origem || !destino;
        }

        // Event listeners para seletores
        document.getElementById('origem-select').addEventListener('change', verificarRotaCompleta);
        document.getElementById('destino-select').addEventListener('change', verificarRotaCompleta);

        // Tra√ßar rota entre origem e destino
        async function tracarRota() {
            const selectOrigem = document.getElementById('origem-select');
            const selectDestino = document.getElementById('destino-select');
            
            if (!selectOrigem.value || !selectDestino.value) {
                alert('Selecione um local de origem e um destino!');
                return;
            }
            
            const origem = JSON.parse(selectOrigem.value);
            const destino = JSON.parse(selectDestino.value);
            
            try {
                const response = await fetch(`${API_URL}/api/rota`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ origem, destino })
                });
                
                const data = await response.json();
                
                if (!data.sucesso) {
                    alert('Erro ao tra√ßar rota: ' + data.erro);
                    return;
                }
                
                // Limpar rota anterior
                limparRota();
                
                // Desenhar nova rota
                desenharRota(data.caminho);
                
                // Mostrar informa√ß√µes no chat
                adicionarMensagemBot(`üìç Rota tra√ßada!\n\nDist√¢ncia: ${data.distancia_estimada}\nTempo: ${data.tempo_estimado}\n\n${data.passo_a_passo.join('\n')}`);
                
            } catch (error) {
                console.error('Erro ao tra√ßar rota:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Desenhar rota no mapa
        function desenharRota(caminho) {
            // Converter pontos do caminho para coordenadas Leaflet [y, x]
            const coordenadas = caminho.map(p => [p.y, p.x]);
            
            // Desenhar linha de rota
            linhaRota = L.polyline(coordenadas, {
                color: '#667eea',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 5',
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            
            // Adicionar marcador de origem
            const marcadorOrigem = L.marker([caminho[0].y, caminho[0].x], {
                icon: L.divIcon({
                    className: 'location-marker origin',
                    html: 'üü¢ ORIGEM'
                })
            }).addTo(map);
            marcadoresRota.push(marcadorOrigem);
            
            // Adicionar marcador de destino
            const ultimoPonto = caminho[caminho.length - 1];
            const marcadorDestino = L.marker([ultimoPonto.y, ultimoPonto.x], {
                icon: L.divIcon({
                    className: 'location-marker destination',
                    html: 'üî¥ DESTINO'
                })
            }).addTo(map);
            marcadoresRota.push(marcadorDestino);
            
            // Ajustar visualiza√ß√£o para mostrar toda a rota
            map.fitBounds(linhaRota.getBounds(), { padding: [50, 50] });
        }

        // Limpar rota do mapa
        function limparRota() {
            if (linhaRota) {
                map.removeLayer(linhaRota);
                linhaRota = null;
            }
            
            marcadoresRota.forEach(marcador => {
                map.removeLayer(marcador);
            });
            marcadoresRota = [];
        }

        // Event listeners
        document.getElementById('predio-select').addEventListener('change', (e) => {
            if (e.target.value) {
                carregarMapaPredio(e.target.value);
                limparRota();
            }
        });

        document.getElementById('tracar-rota-btn').addEventListener('click', tracarRota);
        document.getElementById('limpar-rota-btn').addEventListener('click', () => {
            limparRota();
            adicionarMensagemBot('Rota removida do mapa.');
        });

        // ==== CHAT ====
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-input-form');
        const chatInput = document.getElementById('chat-input');

        function adicionarMensagem(texto, tipo) {
            const div = document.createElement('div');
            div.className = `message ${tipo}`;
            div.textContent = texto;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function adicionarMensagemBot(texto) {
            adicionarMensagem(texto, 'bot');
        }

        function adicionarMensagemUsuario(texto) {
            adicionarMensagem(texto, 'user');
        }

        // Enviar mensagem ao chatbot
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const mensagem = chatInput.value.trim();
            
            if (!mensagem) return;

            adicionarMensagemUsuario(mensagem);
            chatInput.value = '';

            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mensagem })
                });

                const data = await response.json();
                adicionarMensagemBot(data.resposta);

                // Se houver a√ß√£o de mostrar no mapa
                if (data.acao === 'mostrar_no_mapa' && data.dados) {
                    const predioId = data.dados.predio_id;
                    document.getElementById('predio-select').value = predioId;
                    await carregarMapaPredio(predioId);
                    
                    // Destacar o local
                    const coords = data.dados.coordenadas;
                    map.setView([coords.y, coords.x], 1);
                }

            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                adicionarMensagemBot('Desculpe, ocorreu um erro ao processar sua mensagem.');
            }
        });

        // Inicializar aplica√ß√£o
        carregarGeoJSON();  // Carrega GeoJSON primeiro
        carregarPredios();
    </script>
</body>
</html>
